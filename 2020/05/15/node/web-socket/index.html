<!DOCTYPE html><html lang="cn"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> web-socket · 快乐的图小灵</title><meta name="description" content="web-socket - turing5467"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favi.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://turing5467.github.io/atom.xml" title="快乐的图小灵"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">图小灵的博客</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="https://github.com/turing5467" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">web-socket</h1><div class="post-info">May 15, 2020</div><div class="post-content"><h2 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h2><h3 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h3><ul>
<li>HTTP：超文本传输协议，是互联网上应用最为广泛的一种网络协议。用于从WWW服务器传输超文本到本地浏览器的传送协议</li>
</ul>
<h3 id="HTTP请求"><a href="#HTTP请求" class="headerlink" title="HTTP请求"></a>HTTP请求</h3><ol>
<li>建立连接（三次握手）</li>
<li>发送请求（Request）</li>
<li>响应请求（Response）</li>
<li>断开连接（四次挥手）</li>
</ol>
<h3 id="WebSocket-1"><a href="#WebSocket-1" class="headerlink" title="WebSocket"></a>WebSocket</h3><p>WebSocket协议是基于TCP的一种新的网络协议。它实现了浏览器与服务器全双工通信（full-duple）——允许服务器主动发送信息给客户端。</p>
<p>websocket是一种持久协议，http是非持久协议</p>
<blockquote>
<p>全双工通信： 又称为双向同时<em>通信</em>，即<em>通信</em>的双方可以同时发送和接收信息的信息交互方式。 </p>
</blockquote>
<p>早期没有websocket时，通过<strong>ajax轮询</strong>，由于http请求时，服务器无法给浏览器主动发送数据，因此需要浏览器定时给服务器发送数据，然后服务器再把新的数据响应给浏览器。</p>
<p>这种模式的缺点是浪费性能和资源。</p>
<p><img src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200516132911947.png" alt="image-20200516132911947"></p>
<blockquote>
<p>HTTP请求：每次发送请求都要建立连接，请求结束要关闭连接。</p>
<p>​    无状态。每次请求都是独立的。</p>
<p>WebSocket请求：建立连接（借助HTTP）后便可以同时发送和接收数据</p>
</blockquote>
<h3 id="WebSocket请求头"><a href="#WebSocket请求头" class="headerlink" title="WebSocket请求头"></a>WebSocket请求头</h3><p><img src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200515205438552.png" alt="image-20200515205438552"></p>
<h3 id="WebSocket对象"><a href="#WebSocket对象" class="headerlink" title="WebSocket对象"></a>WebSocket对象</h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket" target="_blank" rel="noopener">WebSocket-MDN</a></p>
<p>WebSocket对象提供了一组API，用于创建和管理WebSocket连接，以及通过连接发送和接受数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	构造函数：</span></span><br><span class="line"><span class="comment">		new WebSocket(url, [protocals])</span></span><br><span class="line"><span class="comment">			url: 表示要连接的URL，以ws://开头，如'ws://echo.websocket.org'</span></span><br><span class="line"><span class="comment">			protocal: 可以是单一的协议或多个协议字符串组成的数组</span></span><br><span class="line"><span class="comment">	方法：</span></span><br><span class="line"><span class="comment">		1. send(data)  通过WebSocket连接向服务器发送数据</span></span><br><span class="line"><span class="comment">		2. close([code], [reason]) 关闭连接或停止正在进行的连接请求。</span></span><br><span class="line"><span class="comment">			code：关闭连接的状态号</span></span><br><span class="line"><span class="comment">			reason：连接被关闭的原因</span></span><br><span class="line"><span class="comment">    属性</span></span><br><span class="line"><span class="comment">    	1. onclose：[连接关闭]事件监听器，接收一个CloseEvent对象</span></span><br><span class="line"><span class="comment">    	2. onerror：[通信错误]事件监听器，接收一个error event对象</span></span><br><span class="line"><span class="comment">    	3. onmessage：[客户端接收服务端数据]事件监听器，接收一个MessageEvent对象</span></span><br><span class="line"><span class="comment">    	4. onopen：[建立连接]事件监听器，接收一个Event对象</span></span><br><span class="line"><span class="comment">    	5. readyState：连接状态 </span></span><br><span class="line"><span class="comment">    		0还未连接 1 连接开启并准备好通信</span></span><br><span class="line"><span class="comment">    		2连接正在关闭  3连接已关闭</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过控制台 =&gt; Network =&gt; WS 可以查看WebSocket连接信息</p>
</blockquote>
<h4 id="MessageEvent"><a href="#MessageEvent" class="headerlink" title="MessageEvent"></a>MessageEvent</h4><ul>
<li><code>event.data</code>为服务器接收到信息后返回的数据</li>
</ul>
<p><img src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200516135426382.png" alt="image-20200516135426382"></p>
<h4 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h4><p><img src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200516135551659.png" alt="image-20200516135551659"></p>
<h4 id="CloseEvent"><a href="#CloseEvent" class="headerlink" title="CloseEvent"></a>CloseEvent</h4><p><img src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200516135613777.png" alt="image-20200516135613777"></p>
<h3 id="常用库"><a href="#常用库" class="headerlink" title="常用库"></a>常用库</h3><ol>
<li>ws：小而美</li>
<li>socket.io：大而全，封装了多种协议的websocket库</li>
<li>websocket</li>
</ol>
<h2 id="ws"><a href="#ws" class="headerlink" title="ws"></a>ws</h2><ol>
<li><p>纯WebSocket实现，不支持降级轮询，适用移动端开发</p>
</li>
<li><p>api简单易懂，client没有限制，可以用原生的</p>
</li>
<li><p>心跳检测，断线重连，多机多进程自由定制</p>
</li>
</ol>
<h4 id="广播"><a href="#广播" class="headerlink" title="广播"></a>广播</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> WebSocket = <span class="built_in">require</span>(<span class="string">'ws'</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> wss = <span class="keyword">new</span> WebSocket.Server(&#123; <span class="attr">port</span>: <span class="number">8080</span> &#125;);</span><br><span class="line"> </span><br><span class="line">wss.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span> <span class="title">connection</span>(<span class="params">ws</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//每个连接对应的ws都不同</span></span><br><span class="line">  ws.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span> <span class="title">incoming</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">    wss.clients.forEach(<span class="function"><span class="keyword">function</span> <span class="title">each</span>(<span class="params">client</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (client.readyState === WebSocket.OPEN) &#123;</span><br><span class="line">        client.send(msg);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">    </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="简易聊天室"><a href="#简易聊天室" class="headerlink" title="简易聊天室"></a>简易聊天室</h4><p><img src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200516150529480.png" alt="image-20200516150529480"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//前端部分代码</span></span><br><span class="line"><span class="keyword">let</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">'ws://localhost:8080'</span>);</span><br><span class="line"></span><br><span class="line">ws.onmessage = <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    box.innerHTML += res.data + <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">    input_msg.value = <span class="string">''</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//服务端</span></span><br><span class="line"><span class="keyword">const</span> WebSocket = <span class="built_in">require</span>(<span class="string">'ws'</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> wss = <span class="keyword">new</span> WebSocket.Server(&#123; <span class="attr">port</span>: <span class="number">8080</span> &#125;);</span><br><span class="line"><span class="keyword">let</span> count = <span class="number">0</span>; </span><br><span class="line"></span><br><span class="line">wss.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span> <span class="title">connection</span>(<span class="params">ws</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//每次连接都会创建一个新的ws对象</span></span><br><span class="line">    count++;</span><br><span class="line">    ws.name = <span class="string">'用户'</span>+count; </span><br><span class="line"></span><br><span class="line">    <span class="comment">//广播：用户xx加入了聊天室</span></span><br><span class="line">    wss.clients.forEach(<span class="function">(<span class="params">client</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (client.readyState === WebSocket.OPEN) &#123;</span><br><span class="line">            <span class="comment">//注意是ws.name而不是client.name</span></span><br><span class="line">            client.send(<span class="string">`<span class="subst">$&#123;ws.name&#125;</span>加入聊天室`</span>);</span><br><span class="line">          &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">  ws.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span> <span class="title">incoming</span>(<span class="params">message</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//广播：用户xx发送了xx消息</span></span><br><span class="line">    wss.clients.forEach(<span class="function">(<span class="params">client</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (client.readyState === WebSocket.OPEN) &#123;</span><br><span class="line">            client.send(<span class="string">`<span class="subst">$&#123;ws.name&#125;</span>：<span class="subst">$&#123;message&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  ws.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123; </span><br><span class="line">      <span class="comment">//广播：用户xx离开了聊天室</span></span><br><span class="line">      wss.clients.forEach(<span class="function">(<span class="params">client</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (client.readyState === WebSocket.OPEN) &#123;</span><br><span class="line">            client.send(<span class="string">`<span class="subst">$&#123;ws.name&#125;</span>退出了聊天室`</span>);</span><br><span class="line">          &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">   &#125;)</span><br><span class="line"> </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="socket-io"><a href="#socket-io" class="headerlink" title="socket.io"></a><a href="https://socket.io/docs/" target="_blank" rel="noopener">socket.io</a></h2><ul>
<li>可以在浏览器和服务器之间实现实时，双向和基于事件的通信。</li>
<li>即可在服务端，又可在客户端使用</li>
<li>不是基于WebSocket实现的，只是偶尔使用</li>
<li>可以发送对象，而不单单是字符串</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> io = <span class="built_in">require</span>(<span class="string">'socket.io'</span>)(<span class="number">8080</span>);</span><br><span class="line"></span><br><span class="line">io.on(<span class="string">'connection'</span>, socket =&gt; &#123;</span><br><span class="line">    <span class="comment">//注册自定义事件</span></span><br><span class="line">    socket.on(<span class="string">'xx'</span>, (params) =&gt; &#123;&#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//触发自定义事件(也可在客户端触发)</span></span><br><span class="line">    socket.emit(<span class="string">'xx'</span>, params)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="简易聊天室-1"><a href="#简易聊天室-1" class="headerlink" title="简易聊天室"></a>简易聊天室</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//客户端</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> ws = io(<span class="string">'http://localhost:8080'</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">    ws.on(<span class="string">'message'</span>, (data) =&gt; &#123;</span></span><br><span class="line"><span class="javascript">        box.innerHTML += data.msg + <span class="string">'&lt;br&gt;'</span>;</span></span><br><span class="line"><span class="javascript">        input_msg.value = <span class="string">''</span>;</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="javascript">    btn.onclick = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> msg = input_msg.value;</span></span><br><span class="line">        ws.send(msg);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//服务端</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> io = <span class="built_in">require</span>(<span class="string">'socket.io'</span>)(<span class="number">8080</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> count = <span class="number">0</span>; </span><br><span class="line"></span><br><span class="line">io.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">socket</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  count++;</span><br><span class="line">  socket.name = <span class="string">'用户'</span>+count; </span><br><span class="line">    </span><br><span class="line">  io.sockets.emit(<span class="string">'message'</span>, &#123;<span class="string">'msg'</span>: <span class="string">`<span class="subst">$&#123;socket.name&#125;</span>加入聊天室 --<span class="subst">$&#123;getTime()&#125;</span>`</span>&#125;)</span><br><span class="line">    </span><br><span class="line">  socket.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">      </span><br><span class="line">    io.sockets.emit(<span class="string">'message'</span>,&#123;<span class="string">'msg'</span>: <span class="string">`<span class="subst">$&#123;socket.name&#125;</span>：<span class="subst">$&#123;msg&#125;</span>  <span class="subst">$&#123;getTime()&#125;</span>`</span>&#125;)</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  socket.on(<span class="string">'disconnect'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    io.sockets.emit(<span class="string">'message'</span>, &#123;<span class="string">'msg'</span>: <span class="string">`<span class="subst">$&#123;socket.name&#125;</span>离开聊天室 --<span class="subst">$&#123;getTime()&#125;</span>`</span>&#125;)</span><br><span class="line">    count--;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTime</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Date</span>().toTimeString().slice(<span class="number">0</span>,<span class="number">8</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

</div></article></div></main><footer><div class="paginator"><a href="/2020/05/21/js框架/react/React_Native/" class="prev">PREV</a><a href="/2020/05/15/js/性能优化/防抖节流/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'seansun';
var disqus_identifier = '2020/05/15/node/web-socket/';
var disqus_title = 'web-socket';
var disqus_url = 'https://turing5467.github.io/2020/05/15/node/web-socket/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//seansun.disqus.com/count.js" async></script><div class="copyright"><p>© 2019 - 2020 <a href="https://turing5467.github.io">turing5467</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>